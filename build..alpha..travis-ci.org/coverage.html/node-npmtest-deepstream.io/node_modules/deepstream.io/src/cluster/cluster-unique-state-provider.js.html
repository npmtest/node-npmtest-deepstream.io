<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-deepstream.io/node_modules/deepstream.io/src/cluster/cluster-unique-state-provider.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-deepstream.io">npmtest-deepstream.io (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-deepstream.io/node_modules/deepstream.io/src/cluster/cluster-unique-state-provider.js</span></h1>
    <h2>
        
        Statements: <span class="metric">11.27% <small>(8 / 71)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 24)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 14)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">11.27% <small>(8 / 71)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-deepstream.io/node_modules/deepstream.io/src/cluster/</a> &#187; cluster-unique-state-provider.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict'
&nbsp;
const C = require('../constants/constants')
const utils = require('../utils/utils')
const EventEmitter = require('events').EventEmitter
&nbsp;
const SUPPORTED_ACTIONS = {}
SUPPORTED_ACTIONS[C.ACTIONS.LOCK_RESPONSE] = true
SUPPORTED_ACTIONS[C.ACTIONS.LOCK_REQUEST] = true
SUPPORTED_ACTIONS[C.ACTIONS.LOCK_RELEASE] = true
&nbsp;
/**
 * The unique registry is responsible for maintaing a single source of truth
 * within the cluster, used mainly for issuing cluster wide locks when an operation
 * that stretches over multiple nodes are required.
 *
 * For example, distributed listening requires a leader to drive the nodes in sequence,
 * so issuing a lock prevents multiple nodes from assuming the lead.
 *
 */
module.exports = class UniqueRegistry {
  /**
  * The unique registry is a singleton and is only created once
  * within deepstream.io. It is passed via
  * via the options object.
  *
  * @param  {Object} options                     The options deepstream was created with
  * @param  {ClusterRegistry} clusterRegistry    The cluster registry, used to get the
  *                                              cluster leader
  *
  * @constructor
  */
  constructor <span class="fstat-no" title="function not covered" >(options, clusterRegistry) {</span>
<span class="cstat-no" title="statement not covered" >    this._options = options</span>
<span class="cstat-no" title="statement not covered" >    this._clusterRegistry = clusterRegistry</span>
<span class="cstat-no" title="statement not covered" >    this._locks = {}</span>
<span class="cstat-no" title="statement not covered" >    this._timeouts = {}</span>
<span class="cstat-no" title="statement not covered" >    this._responseEventEmitter = new EventEmitter()</span>
<span class="cstat-no" title="statement not covered" >    this._onPrivateMessageFn = this._onPrivateMessage.bind(this)</span>
<span class="cstat-no" title="statement not covered" >    this._localTopic = this._getPrivateTopic(this._options.serverName)</span>
<span class="cstat-no" title="statement not covered" >    this._options.messageConnector.subscribe(this._localTopic, this._onPrivateMessageFn)</span>
  }
&nbsp;
  /**
  * Requests a lock, if the leader ( whether local or distributed ) has the lock availble
  * it will invoke the callback with true, otherwise false.
  *
  * @param  {String}   name     the lock name that is desired
  * @param  {Function} callback the callback to be told if the lock has been reserved succesfully
  *
  * @public
  * @returns {void}
  */
  get <span class="fstat-no" title="function not covered" >(name, callback) {</span>
<span class="cstat-no" title="statement not covered" >    const leaderServerName = this._clusterRegistry.getCurrentLeader()</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (this._options.serverName === leaderServerName) {</span>
<span class="cstat-no" title="statement not covered" >      callback(this._getLock(name))</span>
    } else <span class="cstat-no" title="statement not covered" >if (!this._timeouts[name]) {</span>
<span class="cstat-no" title="statement not covered" >      this._getRemoteLock(name, leaderServerName, callback)</span>
    } else {
<span class="cstat-no" title="statement not covered" >      callback(false)</span>
    }
  }
&nbsp;
  /**
  * Release a lock, allowing other resources to request it again
  *
  * @param  {String}   name     the lock name that is desired
  *
  * @public
  * @returns {void}
  */
  release <span class="fstat-no" title="function not covered" >(name) {</span>
<span class="cstat-no" title="statement not covered" >    const leaderServerName = this._clusterRegistry.getCurrentLeader()</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (this._options.serverName === leaderServerName) {</span>
<span class="cstat-no" title="statement not covered" >      this._releaseLock(name)</span>
    } else {
<span class="cstat-no" title="statement not covered" >      this._releaseRemoteLock(name, leaderServerName)</span>
    }
  }
&nbsp;
  /**
  * Called when the current node is not the leader, issuing a lock request
  * via the message bus
  *
  * @param  {String}   name             The lock name
  * @param  {String}   leaderServerName The leader of the cluster
  * @param  {Function} callback         The callback to invoke once a response
  *                                     from the server is retrieved
  * @private
  * @returns {void}
  */
  _getRemoteLock <span class="fstat-no" title="function not covered" >(name, leaderServerName, callback) {</span>
<span class="cstat-no" title="statement not covered" >    this._timeouts[name] = utils.setTimeout(</span>
            this._onLockRequestTimeout.bind(this, name),
            this._options.lockRequestTimeout
        )
&nbsp;
<span class="cstat-no" title="statement not covered" >    this._responseEventEmitter.once(name, callback)</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    const remoteTopic = this._getPrivateTopic(leaderServerName)</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    this._options.messageConnector.publish(remoteTopic, {</span>
      topic: remoteTopic,
      action: C.ACTIONS.LOCK_REQUEST,
      data: [{
        name,
        responseTopic: this._localTopic
      }]
    })
  }
&nbsp;
  /**
  * Notifies a remote leader keeping a lock that said lock is no longer required
  *
  * @param  {String}   name             The lock name
  * @param  {String}   leaderServerName The leader of the cluster
  *
  * @private
  * @returns {void}
  */
  _releaseRemoteLock <span class="fstat-no" title="function not covered" >(name, leaderServerName) {</span>
<span class="cstat-no" title="statement not covered" >    const remoteTopic = this._getPrivateTopic(leaderServerName)</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    this._options.messageConnector.publish(remoteTopic, {</span>
      topic: remoteTopic,
      action: C.ACTIONS.LOCK_RELEASE,
      data: [{
        name
      }]
    })
  }
&nbsp;
  /**
  * Called when a message is recieved on the message bus.
  * This could mean the leader responded to a request or that you're currently
  * the leader and recieved a request.
  *
  * @param  {Object} message Object from message bus
  *
  * @private
  * @returns {void}
  */
  _onPrivateMessage <span class="fstat-no" title="function not covered" >(message) {</span>
<span class="cstat-no" title="statement not covered" >    if (!SUPPORTED_ACTIONS[message.action]) {</span>
<span class="cstat-no" title="statement not covered" >      this._options.logger.log(C.LOG_LEVEL.WARN, C.EVENT.UNKNOWN_ACTION, message.action)</span>
<span class="cstat-no" title="statement not covered" >      return</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (!message.data || !message.data[0]) {</span>
<span class="cstat-no" title="statement not covered" >      this._options.logger.log(C.LOG_LEVEL.WARN, C.EVENT.INVALID_MESSAGE_DATA, message.data)</span>
<span class="cstat-no" title="statement not covered" >      return</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (message.action === C.ACTIONS.LOCK_RESPONSE) {</span>
<span class="cstat-no" title="statement not covered" >      this._handleRemoteLockResponse(message.data[0])</span>
<span class="cstat-no" title="statement not covered" >      return</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (this._clusterRegistry.isLeader() === false) {</span>
<span class="cstat-no" title="statement not covered" >      let remoteServerName = 'unknown-server'</span>
<span class="cstat-no" title="statement not covered" >      if (message.data[0].responseTopic) {</span>
<span class="cstat-no" title="statement not covered" >        remoteServerName = message.data[0].responseTopic.replace(C.TOPIC.LEADER_PRIVATE, '')</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      this._options.logger.log(</span>
                C.LOG_LEVEL.WARN,
                C.EVENT.INVALID_LEADER_REQUEST,
                `server ${remoteServerName} assumes this node '${this._options.serverName}' is the leader`
            )
&nbsp;
<span class="cstat-no" title="statement not covered" >      return</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (message.action === C.ACTIONS.LOCK_REQUEST) {</span>
<span class="cstat-no" title="statement not covered" >      this._handleRemoteLockRequest(message.data[0])</span>
    } else <span class="cstat-no" title="statement not covered" >if (message.action === C.ACTIONS.LOCK_RELEASE) {</span>
<span class="cstat-no" title="statement not covered" >      this._handleRemoteLockRelease(message.data[0])</span>
    }
  }
&nbsp;
  /**
  * Called when a remote lock request is received
  *
  * @param  {Object} data messageData
  *
  * @private
  * @returns {void}
  */
  _handleRemoteLockRequest <span class="fstat-no" title="function not covered" >(data) {</span>
<span class="cstat-no" title="statement not covered" >    this._options.messageConnector.publish(data.responseTopic, {</span>
      topic: data.responseTopic,
      action: C.ACTIONS.LOCK_RESPONSE,
      data: [{
        name: data.name,
        result: this._getLock(data.name)
      }]
    })
  }
&nbsp;
  /**
  * Called when a remote lock response is received
  *
  * @param  {Object} data messageData
  *
  * @private
  * @returns {void}
  */
  _handleRemoteLockResponse <span class="fstat-no" title="function not covered" >(data) {</span>
<span class="cstat-no" title="statement not covered" >    clearTimeout(this._timeouts[data.name])</span>
<span class="cstat-no" title="statement not covered" >    delete this._timeouts[data.name]</span>
<span class="cstat-no" title="statement not covered" >    this._responseEventEmitter.emit(data.name, data.result)</span>
  }
&nbsp;
  /**
  * Called when a remote node notifies the cluster that a lock has been removed
  *
  * @param  {Object} data messageData
  *
  * @private
  * @returns {void}
  */
  _handleRemoteLockRelease <span class="fstat-no" title="function not covered" >(data) {</span>
<span class="cstat-no" title="statement not covered" >    clearTimeout(this._timeouts[data.name])</span>
<span class="cstat-no" title="statement not covered" >    delete this._timeouts[data.name]</span>
<span class="cstat-no" title="statement not covered" >    delete this._locks[data.name]</span>
  }
&nbsp;
  /**
  * Generates a private topic to allow routing requests directly
  * to this node
  *
  * @param  {String} serverName The server of this server
  *
  * @private
  * @returns {String} privateTopic
  */
  _getPrivateTopic <span class="fstat-no" title="function not covered" >(serverName) {</span> // eslint-disable-line
<span class="cstat-no" title="statement not covered" >    return C.TOPIC.LEADER_PRIVATE + serverName</span>
  }
&nbsp;
  /**
  * Returns true if reserving lock was possible otherwise returns false
  *
  * @param  {String}   name     Name of lock
  *
  * @private
  * @return {boolean}
  */
  _getLock <span class="fstat-no" title="function not covered" >(name) {</span>
<span class="cstat-no" title="statement not covered" >    if (this._locks[name] === true) {</span>
<span class="cstat-no" title="statement not covered" >      return false</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    this._timeouts[name] = utils.setTimeout(</span>
      this._onLockTimeout.bind(this, name),
      this._options.lockTimeout
    )
<span class="cstat-no" title="statement not covered" >    this._locks[name] = true</span>
<span class="cstat-no" title="statement not covered" >    return true</span>
  }
&nbsp;
  /**
  * Called when a lock is no longer required and can be released. This is triggered either by
  * a timeout if a remote release message wasn't received in time or when release was called
  * locally.
  *
  * Important note: Anyone can release a lock. It is assumed that the cluster is trusted
  * so maintaining who has the lock is not required. This may need to change going forward.
  *
  * @param  {String} name Lock name
  *
  * @private
  * @returns {void}
  */
  _releaseLock <span class="fstat-no" title="function not covered" >(name) {</span>
<span class="cstat-no" title="statement not covered" >    clearTimeout(this._timeouts[name])</span>
<span class="cstat-no" title="statement not covered" >    delete this._timeouts[name]</span>
<span class="cstat-no" title="statement not covered" >    delete this._locks[name]</span>
  }
&nbsp;
  /**
  * Called when a timeout occurs on a lock that has been reserved for too long
  *
  * @param  {String} name The lock name
  *
  * @private
  * @returns {void}
  */
  _onLockTimeout <span class="fstat-no" title="function not covered" >(name) {</span>
<span class="cstat-no" title="statement not covered" >    this._releaseLock(name)</span>
<span class="cstat-no" title="statement not covered" >    this._options.logger.log(C.LOG_LEVEL.WARN, C.EVENT.TIMEOUT, `lock ${name} released due to timeout`)</span>
  }
&nbsp;
  /**
  * Called when a remote request has timed out, resulting in notifying the client that
  * the lock wasn't able to be reserved
  *
  * @param  {String} name The lock name
  *
  * @private
  * @returns {void}
  */
  _onLockRequestTimeout <span class="fstat-no" title="function not covered" >(name) {</span>
<span class="cstat-no" title="statement not covered" >    this._handleRemoteLockResponse({ name, result: false })</span>
<span class="cstat-no" title="statement not covered" >    this._options.logger.log(C.LOG_LEVEL.WARN, C.EVENT.TIMEOUT, `request for lock ${name} timed out`)</span>
  }
}
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Thu Apr 20 2017 16:09:03 GMT+0000 (UTC)</div>
</div>
</body>
</html>
