<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-deepstream.io/node_modules/deepstream.io/src/permission/config-permission-handler.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-deepstream.io">npmtest-deepstream.io (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-deepstream.io/node_modules/deepstream.io/src/permission/config-permission-handler.js</span></h1>
    <h2>
        
        Statements: <span class="metric">26.92% <small>(21 / 78)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 29)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 9)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">27.27% <small>(21 / 77)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-deepstream.io/node_modules/deepstream.io/src/permission/</a> &#187; config-permission-handler.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict'
/* eslint-disable valid-typeof */
const configValidator = require('./config-validator')
const configCompiler = require('./config-compiler')
const rulesMap = require('./rules-map')
const RuleApplication = require('./rule-application')
const RuleCache = require('./rule-cache')
const events = require('events')
const utils = require('util')
const jsYamlLoader = require('../config/js-yaml-loader')
&nbsp;
const STRING = 'string'
const UNDEFINED = 'undefined'
&nbsp;
/**
 * A permission handler that reads a rules config YAML or JSON, validates
 * its contents, compiles it and executes the permissions that it contains
 * against every incoming message.
 *
 * This is the standard permission handler that deepstream exposes, in conjunction
 * with the default permission.yml it allows everything, but at the same time provides
 * a convenient starting point for permission declarations.
 *
 * @author deepstreamHub GmbH
 * @license [https://github.com/deepstreamIO/deepstream.io/blob/master/LICENSE] MIT
 *
 * @constructor
 * @extends {EventEmitter}
 *
 * @param {Object} options deepstream options
 * @param {[Object]} config  Optional config. If no config is provided, the
 *                           ConfigPermissionHandler will attempt
 *                           to load it from the path provided in options.path.
 */
const ConfigPermissionHandler = <span class="fstat-no" title="function not covered" >function (options, config) {</span>
<span class="cstat-no" title="statement not covered" >  this._ruleCache = new RuleCache(options)</span>
<span class="cstat-no" title="statement not covered" >  this._options = options</span>
<span class="cstat-no" title="statement not covered" >  this._permissionOptions = options.permission.options</span>
<span class="cstat-no" title="statement not covered" >  this._config = null</span>
<span class="cstat-no" title="statement not covered" >  this._recordHandler = null</span>
<span class="cstat-no" title="statement not covered" >  this.isReady = false</span>
<span class="cstat-no" title="statement not covered" >  this.type = `valve permissions loaded from ${this._permissionOptions.path}`</span>
<span class="cstat-no" title="statement not covered" >  this._optionsValid = true</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  const maxRuleIterations = options.permission.options.maxRuleIterations</span>
<span class="cstat-no" title="statement not covered" >  if (maxRuleIterations !== undefined &amp;&amp; maxRuleIterations &lt; 1) {</span>
<span class="cstat-no" title="statement not covered" >    this._optionsValid = false</span>
<span class="cstat-no" title="statement not covered" >    process.nextTick(() =&gt; <span class="cstat-no" title="statement not covered" >this.emit('error', 'Maximum rule iteration has to be at least one '))</span></span>
  } else <span class="cstat-no" title="statement not covered" >if (config) {</span>
<span class="cstat-no" title="statement not covered" >    this.useConfig(config)</span>
  }
}
&nbsp;
utils.inherits(ConfigPermissionHandler, events.EventEmitter)
&nbsp;
/**
 * Will be invoked with the initialised recordHandler instance by deepstream.io
 *
 * @param {RecordHandler} recordHandler
 *
 * @public
 * @returns {void}
 */
ConfigPermissionHandler.prototype.setRecordHandler = <span class="fstat-no" title="function not covered" >function (recordHandler) {</span>
<span class="cstat-no" title="statement not covered" >  this._recordHandler = recordHandler</span>
}
&nbsp;
/**
 * Will be called by the dependency initialiser once server.start() is called.
 * This gives users a chance to change the path using server.set()
 * first
 *
 * @public
 * @returns {void}
 */
ConfigPermissionHandler.prototype.init = <span class="fstat-no" title="function not covered" >function () {</span>
<span class="cstat-no" title="statement not covered" >  if (this._config === null &amp;&amp; this._optionsValid) {</span>
<span class="cstat-no" title="statement not covered" >    this.loadConfig(this._permissionOptions.path)</span>
  }
}
&nbsp;
/**
 * Load a configuration file. This will either load a configuration file for the first time at
 * startup or reload the configuration at runtime
 *
 * CLI loadConfig &lt;path&gt;
 *
 * @todo expose this method via the command line interface
 *
 * @param   {String} path the filepath of the permission.yml file
 *
 * @public
 * @returns {void}
 */
ConfigPermissionHandler.prototype.loadConfig = <span class="fstat-no" title="function not covered" >function (filePath) {</span>
<span class="cstat-no" title="statement not covered" >  jsYamlLoader.readAndParseFile(filePath, this._onConfigLoaded.bind(this, filePath))</span>
}
&nbsp;
/**
 * Validates and compiles a loaded config. This can be called as the result
 * of a config being passed to the permissionHandler upon initialisation,
 * as a result of loadConfig or at runtime
 *
 * CLI useConfig &lt;config&gt;
 *
 * @todo expose this method via the command line interface
 *
 * @param   {Object} config deepstream permissionConfig
 *
 * @public
 * @returns {void}
 */
ConfigPermissionHandler.prototype.useConfig = <span class="fstat-no" title="function not covered" >function (config) {</span>
<span class="cstat-no" title="statement not covered" >  const validationResult = configValidator.validate(config)</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (validationResult !== true) {</span>
<span class="cstat-no" title="statement not covered" >    this.emit('error', `invalid permission config - ${validationResult}`)</span>
<span class="cstat-no" title="statement not covered" >    return</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  this._config = configCompiler.compile(config)</span>
<span class="cstat-no" title="statement not covered" >  this._ruleCache.reset()</span>
<span class="cstat-no" title="statement not covered" >  this._ready()</span>
}
&nbsp;
/**
 * Implements the permissionHandler's canPerformAction interface
 * method
 *
 * This is the main entry point for permissionOperations and will
 * be called for every incoming message. This method executes four steps
 *
 * - Check if the incoming message conforms to basic specs
 * - Check if the incoming message requires permissions
 * - Load the applicable permissions
 * - Apply them
 *
 * @param   {String}   username the name of the connected user, as specified in isValidUser
 * @param   {Object}   message  a parsed deepstream message
 * @param   {Function} callback the callback to provide the result
 * @param   {[Object]}   authData additional optional authData as passed to isValidUser
 *
 * @public
 * @interface
 * @returns {void}
 */
ConfigPermissionHandler.prototype.canPerformAction = <span class="fstat-no" title="function not covered" >function (</span>
  username, message, callback, authData) {
<span class="cstat-no" title="statement not covered" >  if (typeof message.data[0] !== STRING) {</span>
<span class="cstat-no" title="statement not covered" >    callback('invalid message', false)</span>
<span class="cstat-no" title="statement not covered" >    return</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  const ruleSpecification = rulesMap.getRulesForMessage(message)</span>
<span class="cstat-no" title="statement not covered" >  const name = message.data[0]</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (ruleSpecification === null) {</span>
<span class="cstat-no" title="statement not covered" >    callback(null, true)</span>
<span class="cstat-no" title="statement not covered" >    return</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  const ruleData = this._getCompiledRulesForName(name, ruleSpecification)</span>
&nbsp;
  // eslint-disable-next-line
<span class="cstat-no" title="statement not covered" >  new RuleApplication({</span>
    recordHandler: this._recordHandler,
    username,
    authData,
    path: ruleData,
    ruleSpecification,
    message,
    action: ruleSpecification.action,
    regexp: ruleData.regexp,
    rule: ruleData.rule,
    name,
    callback,
    logger: this._options.logger,
    permissionOptions: this._permissionOptions,
    options: this._options
  })
}
&nbsp;
/**
 * Evaluates the rules within a section and returns the matching rule for a path.
 * Takes basic specificity (as deduced from the path length) into account and
 * caches frequently used rules for faster access
 *
 * @param   {String} name              the name of the record, event or rpc the rule applies to
 * @param   {Object} ruleSpecification a ruleSpecification as provided by the rules-map
 *
 * @private
 * @returns {Object} compiled rules
 */
ConfigPermissionHandler.prototype._getCompiledRulesForName = <span class="fstat-no" title="function not covered" >function (name, ruleSpecification) {</span>
<span class="cstat-no" title="statement not covered" >  if (this._ruleCache.has(ruleSpecification.section, name, ruleSpecification.type)) {</span>
<span class="cstat-no" title="statement not covered" >    return this._ruleCache.get(ruleSpecification.section, name, ruleSpecification.type)</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  const section = this._config[ruleSpecification.section]</span>
<span class="cstat-no" title="statement not covered" >  let i = 0</span>
<span class="cstat-no" title="statement not covered" >  let pathLength = 0</span>
<span class="cstat-no" title="statement not covered" >  let result = null</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  for (i; i &lt; section.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >    if (</span>
      typeof section[i].rules[ruleSpecification.type] !== UNDEFINED &amp;&amp;
      section[i].path.length &gt;= pathLength &amp;&amp;
      section[i].regexp.test(name)
    ) {
<span class="cstat-no" title="statement not covered" >      pathLength = section[i].path.length</span>
<span class="cstat-no" title="statement not covered" >      result = {</span>
        path: section[i].path,
        regexp: section[i].regexp,
        rule: section[i].rules[ruleSpecification.type]
      }
    }
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (result) {</span>
<span class="cstat-no" title="statement not covered" >    this._ruleCache.set(ruleSpecification.section, name, ruleSpecification.type, result)</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  return result</span>
}
&nbsp;
/**
 * Callback for loadConfig. Parses the incoming configuration string and forwards
 * it to useConfig if no errors occured
 *
 * @param   {Error} loadError a FileSystem Error that occured during the loading of the file
 * @param   {String} data     the content of the permission.yml file as utf-8 encoded string
 *
 * @private
 * @returns {void}
 */
ConfigPermissionHandler.prototype._onConfigLoaded = <span class="fstat-no" title="function not covered" >function (filePath, loadError, config) {</span>
<span class="cstat-no" title="statement not covered" >  if (loadError) {</span>
<span class="cstat-no" title="statement not covered" >    this.emit('error', `error while loading config: ${loadError.toString()}`)</span>
<span class="cstat-no" title="statement not covered" >    return</span>
  }
<span class="cstat-no" title="statement not covered" >  this.emit('config-loaded', filePath)</span>
<span class="cstat-no" title="statement not covered" >  this.useConfig(config)</span>
}
&nbsp;
/**
 * Sets this permissionHandler to ready. Occurs once the config has been successfully loaded,
 * parsed and compiled
 *
 * @private
 * @returns {void}
 */
ConfigPermissionHandler.prototype._ready = <span class="fstat-no" title="function not covered" >function () {</span>
<span class="cstat-no" title="statement not covered" >  if (this.isReady === false) {</span>
<span class="cstat-no" title="statement not covered" >    this.isReady = true</span>
<span class="cstat-no" title="statement not covered" >    this.emit('ready')</span>
  }
}
&nbsp;
module.exports = ConfigPermissionHandler
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Thu Apr 20 2017 16:09:03 GMT+0000 (UTC)</div>
</div>
</body>
</html>
